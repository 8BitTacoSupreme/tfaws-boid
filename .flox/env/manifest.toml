## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##   https://flox.dev/docs/reference/command-reference/manifest.toml/
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
##  $ flox install gum  <- puts a package in [install] section below
##  $ flox search gum   <- search for a package
##  $ flox show gum     <- show all versions of a package
## -------------------------------------------------------------------
[install]
# Core Terraform stack
terraform.pkg-path = "terraform"
awscli2.pkg-path = "awscli2"
localstack.pkg-path = "localstack"
tflint.pkg-path = "tflint"
tfsec.pkg-path = "tfsec"
infracost.pkg-path = "infracost"

# Data & storage
sqlite.pkg-path = "sqlite"
jq.pkg-path = "jq"
yq.pkg-path = "yq-go"

# Container runtime (for LocalStack)
podman.pkg-path = "podman"

# Python (Canon seeding, scripting)
python3.pkg-path = "python3"




# Node.js (MCP servers are typically TypeScript)
nodejs.pkg-path = "nodejs_22"

# AI agent (self-contained boid)
claude-code.pkg-path = "claude-code"

# Shell quality
shellcheck.pkg-path = "shellcheck"
shfmt.pkg-path = "shfmt"

# Utilities
curl.pkg-path = "curl"
git.pkg-path = "git"
tree.pkg-path = "tree"
chromadb.pkg-path = "python313Packages.chromadb"
lancedb.pkg-path = "python313Packages.lancedb"


# gum.pkg-path = "gum"
# gum.version = "^0.14.5"


## Environment Variables ---------------------------------------------
##  ... available for use in the activated environment
##      as well as [hook], [profile] scripts and [services] below.
## -------------------------------------------------------------------
[vars]
# INTRO_MESSAGE = "It's gettin' Flox in here"


## Activation Hook ---------------------------------------------------
##  ... run by _bash_ shell when you run 'flox activate'.
## -------------------------------------------------------------------
[hook]
on-activate = '''
  echo "terraform-aws-boid dev environment"
  echo "  terraform: $(terraform version -json | jq -r '.terraform_version')"
  echo "  aws-cli:   $(aws --version 2>&1 | cut -d/ -f2 | cut -d' ' -f1)"
  echo "  sqlite3:   $(sqlite3 --version | cut -d' ' -f1)"
  echo "  node:      $(node --version)"

  # Initialize boid if running inside a project checkout
  if [[ -n "${FLOX_ENV_PROJECT:-}" && -f "${FLOX_ENV_PROJECT}/scripts/on-activate.sh" ]]; then
    source "${FLOX_ENV_PROJECT}/scripts/on-activate.sh"
  else
    echo "[boid] Remote environment — run inside a project checkout for Memories + Canon"
  fi

  echo "[boid] Claude Code available — run 'claude' or 'boid-init <dir>' to set up a project"
'''
#   # -> Perform initialization steps, e.g. create a python venv
#   # -> Useful environment variables:
#   #      - FLOX_ENV_PROJECT=/home/user/example
#   #      - FLOX_ENV=/home/user/example/.flox/run
#   #      - FLOX_ENV_CACHE=/home/user/example/.flox/cache
# '''


## Profile script ----------------------------------------------------
## ... sourced by _your shell_ when you run 'flox activate'.
## -------------------------------------------------------------------
[profile]
common = '''
  boid-init() {
    local target="${1:-.}"
    local boid_home="${BOID_HOME:-${FLOX_ENV_PROJECT:-.}}"

    if [[ ! -f "${boid_home}/boid-claude.md" ]]; then
      echo "[boid-init] ERROR: Cannot find boid-claude.md at ${boid_home}"
      echo "            Run this from inside an activated boid project checkout."
      return 1
    fi

    # Copy CLAUDE.md (the shipped agent instructions)
    if [[ -f "${target}/CLAUDE.md" ]]; then
      echo "[boid-init] CLAUDE.md already exists in ${target} — backing up to CLAUDE.md.bak"
      cp "${target}/CLAUDE.md" "${target}/CLAUDE.md.bak"
    fi
    cp "${boid_home}/boid-claude.md" "${target}/CLAUDE.md"

    # Create .claude/settings.json with MCP servers pointing to boid
    mkdir -p "${target}/.claude"
    cat > "${target}/.claude/settings.json" <<SETTINGS
{
  "mcpServers": {
    "sqlite": {
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-server-sqlite", "--db-path", "${BOID_MEMORY_DB:-${boid_home}/memory/boid.db}"]
    },
    "fetch": {
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-server-fetch"]
    },
    "terraform": {
      "command": "npx",
      "args": ["-y", "terraform-mcp-server"]
    }
  },
  "permissions": {
    "allow": [
      "Bash(terraform:*)",
      "Bash(aws:*)",
      "Bash(localstack:*)",
      "Bash(tflint:*)",
      "Bash(tfsec:*)",
      "Bash(infracost:*)",
      "Bash(sqlite3:*)",
      "Bash(jq:*)",
      "Bash(podman:*)",
      "Bash(shellcheck:*)",
      "Bash(python3:*)",
      "Bash(node:*)",
      "Bash(npm:*)"
    ]
  }
}
SETTINGS

    echo "[boid-init] Initialized boid agent in ${target}"
    echo "  CLAUDE.md    → boid Terraform+AWS agent instructions"
    echo "  .claude/     → MCP servers (sqlite, fetch, terraform)"
    echo ""
    echo "  Run: cd ${target} && claude"
  }
'''


## Services ---------------------------------------------------------
##  $ flox services start             <- Starts all services
##  $ flox services status            <- Status of running services
##  $ flox activate --start-services  <- Activates & starts all
## ------------------------------------------------------------------
[services]
# myservice.command = "python3 -m http.server"


## Include ----------------------------------------------------------
## ... environments to create a composed environment
## ------------------------------------------------------------------
[include]
# environments = [
#     { dir = "../common" }
# ]


## Build and publish your own packages ------------------------------
##  $ flox build
##  $ flox publish
## ------------------------------------------------------------------
[build]
# [build.myproject]
# description = "The coolest project ever"
# version = "0.0.1"
# command = """
#   mkdir -p $out/bin
#   cargo build --release
#   cp target/release/myproject $out/bin/myproject
# """


## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
# systems = [
#   "aarch64-darwin",
#   "aarch64-linux",
#   "x86_64-darwin",
#   "x86_64-linux",
# ]
# Uncomment to disable CUDA detection.
# cuda-detection = false
