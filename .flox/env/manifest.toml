## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##   https://flox.dev/docs/reference/command-reference/manifest.toml/
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
##  $ flox install gum  <- puts a package in [install] section below
##  $ flox search gum   <- search for a package
##  $ flox show gum     <- show all versions of a package
## -------------------------------------------------------------------
[install]
# Core Terraform stack
terraform.pkg-path = "terraform"
awscli2.pkg-path = "awscli2"
localstack.pkg-path = "localstack"
tflint.pkg-path = "tflint"
tfsec.pkg-path = "tfsec"
infracost.pkg-path = "infracost"

# Data & storage
sqlite.pkg-path = "sqlite"
jq.pkg-path = "jq"
yq.pkg-path = "yq-go"

# Container runtime (for LocalStack)
podman.pkg-path = "podman"

# Python (Canon seeding, scripting)
python3.pkg-path = "python3"




# Node.js (MCP servers are typically TypeScript)
nodejs.pkg-path = "nodejs_22"

# AI agent (self-contained boid) — own pkg-group to get latest version
claude-code.pkg-path = "claude-code"
claude-code.pkg-group = "claude"

# Shell quality
shellcheck.pkg-path = "shellcheck"
shfmt.pkg-path = "shfmt"

# Utilities
curl.pkg-path = "curl"
git.pkg-path = "git"
tree.pkg-path = "tree"
chromadb.pkg-path = "python313Packages.chromadb"
lancedb.pkg-path = "python313Packages.lancedb"
# tfaws-boid package — temporarily removed for publish, re-add after
# tfaws-boid.pkg-path = "8BitTacoSupreme/tfaws-boid"
# tfaws-boid.systems = ["aarch64-darwin"]
# tfaws-boid.pkg-group = "tfaws-boid"


# gum.pkg-path = "gum"
# gum.version = "^0.14.5"


## Environment Variables ---------------------------------------------
##  ... available for use in the activated environment
##      as well as [hook], [profile] scripts and [services] below.
## -------------------------------------------------------------------
[vars]
# INTRO_MESSAGE = "It's gettin' Flox in here"


## Activation Hook ---------------------------------------------------
##  ... run by _bash_ shell when you run 'flox activate'.
## -------------------------------------------------------------------
[hook]
on-activate = '''
  tf_ver=$(terraform version -json | jq -r '.terraform_version')
  aws_ver=$(aws --version 2>&1 | cut -d/ -f2 | cut -d' ' -f1)
  echo "terraform-aws-boid v0.3.0"
  echo "  terraform $tf_ver | aws-cli $aws_ver | tflint | tfsec | infracost"

  # Resolve boid data: prefer packaged (Nix store), fall back to project checkout
  if [[ -d "$FLOX_ENV/share/boid" ]]; then
    BOID_SHARE="$FLOX_ENV/share/boid"
  elif [[ -n "${FLOX_ENV_PROJECT:-}" && -d "${FLOX_ENV_PROJECT}/canon" ]]; then
    BOID_SHARE="${FLOX_ENV_PROJECT}"
  else
    echo "[boid] WARNING: No boid data found. Run from a project checkout or install the tfaws-boid package."
    return 0 2>/dev/null || true
  fi

  # Determine consumer project directory
  PROJECT_DIR="${FLOX_ENV_PROJECT:-$PWD}"

  # --- Symlink skills into consumer project ---
  claude_source="$FLOX_ENV/share/claude"
  claude_target="${PROJECT_DIR}/.claude"
  if [[ -d "$claude_source/skills" ]]; then
    mkdir -p "$claude_target/skills"
    for skill in "$claude_source/skills"/*/; do
      if [[ -d "$skill" ]]; then
        name=$(basename "$skill")
        rm -rf "$claude_target/skills/$name"
        ln -s "$skill" "$claude_target/skills/$name"
        : # skill linked silently
      fi
    done
  elif [[ -n "${FLOX_ENV_PROJECT:-}" && -f "${FLOX_ENV_PROJECT}/SKILL.md" ]]; then
    # Local dev fallback: symlink from project checkout
    mkdir -p "$claude_target/skills/tfaws-boid"
    rm -rf "$claude_target/skills/tfaws-boid/SKILL.md"
    ln -s "${FLOX_ENV_PROJECT}/SKILL.md" "$claude_target/skills/tfaws-boid/SKILL.md"
    : # skill linked silently (local dev)
  fi

  # --- Deploy MCP server config ---
  settings_source="$FLOX_ENV/share/claude/settings.json"
  settings_target="${PROJECT_DIR}/.claude/settings.json"
  if [[ -f "$settings_source" ]]; then
    mkdir -p "${PROJECT_DIR}/.claude"
    if [[ ! -f "$settings_target" ]]; then
      cp "$settings_source" "$settings_target"
    else
      # Merge boid mcpServers into existing settings (additive, no clobber)
      merged=$(jq -s '.[0] * {mcpServers: (.[0].mcpServers // {} + .[1].mcpServers // {})}' \
        "$settings_target" "$settings_source" 2>/dev/null) && \
        echo "$merged" > "$settings_target"
    fi
  elif [[ -n "${FLOX_ENV_PROJECT:-}" && -f "${FLOX_ENV_PROJECT}/.claude/settings.json" ]]; then
    # Local dev fallback: use project checkout settings as source
    mkdir -p "${PROJECT_DIR}/.claude"
    if [[ ! -f "$settings_target" ]]; then
      cp "${FLOX_ENV_PROJECT}/.claude/settings.json" "$settings_target"
    fi
  fi

  # --- Initialize Memories DB ---
  MEMORY_DB="${PROJECT_DIR}/memory/boid.db"
  SCHEMA_FILE="${BOID_SHARE}/memory/schema.sql"
  if [[ ! -f "$MEMORY_DB" && -f "$SCHEMA_FILE" ]]; then
    mkdir -p "${PROJECT_DIR}/memory"
    sqlite3 "$MEMORY_DB" < "$SCHEMA_FILE"
  fi

  # --- Migrate schema if needed ---
  if [[ -f "$MEMORY_DB" ]]; then
    SCHEMA_VER="$(sqlite3 "$MEMORY_DB" "SELECT value FROM metadata WHERE key='"'"'schema_version'"'"';" 2>/dev/null || echo '0')"
    MIGRATE_FILE="${BOID_SHARE}/memory/migrate_v1_to_v2.sql"
    if [[ "$SCHEMA_VER" == "1" && -f "$MIGRATE_FILE" ]]; then
      sqlite3 "$MEMORY_DB" < "$MIGRATE_FILE"
    fi
  fi

  # --- Validate Canon ---
  canon_files=("error-signatures.json" "aws-limits.json" "provider-compat.json" "iam-eval-rules.json" "sg-interactions.json" "localstack-limitations.json")
  canon_count=0
  for f in "${canon_files[@]}"; do
    [[ -f "${BOID_SHARE}/canon/${f}" ]] && canon_count=$((canon_count + 1))
  done

  # --- Session tracking ---
  SESSION_ID="$(python3 -c 'import uuid; print(uuid.uuid4())')"
  if [[ -f "$MEMORY_DB" ]]; then
    sqlite3 "$MEMORY_DB" "INSERT INTO sessions (session_id, project_dir) VALUES ('${SESSION_ID}', '${PROJECT_DIR}');" 2>/dev/null || true
  fi

  # --- Export env vars ---
  export BOID_HOME="$BOID_SHARE"
  export BOID_CANON_DIR="${BOID_SHARE}/canon"
  export BOID_MEMORY_DB="$MEMORY_DB"
  export BOID_SESSION_ID="$SESSION_ID"
  export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-us-east-1}"
  export PYTHONDONTWRITEBYTECODE=1

  # --- Compact status line ---
  mem_status="none"
  [[ -f "$MEMORY_DB" ]] && mem_status="ready"
  echo "  Canon: ${canon_count}/${#canon_files[@]} | Memories: ${mem_status} | Session: ${SESSION_ID:0:8}"
  echo ""
  echo "  Run 'claude' to start"
'''
#   # -> Perform initialization steps, e.g. create a python venv
#   # -> Useful environment variables:
#   #      - FLOX_ENV_PROJECT=/home/user/example
#   #      - FLOX_ENV=/home/user/example/.flox/run
#   #      - FLOX_ENV_CACHE=/home/user/example/.flox/cache
# '''


## Profile script ----------------------------------------------------
## ... sourced by _your shell_ when you run 'flox activate'.
## -------------------------------------------------------------------
[profile]
common = '''
  export BOID_HOME="${BOID_HOME:-}"
  export BOID_CANON_DIR="${BOID_CANON_DIR:-}"
  export BOID_MEMORY_DB="${BOID_MEMORY_DB:-}"
'''


## Services ---------------------------------------------------------
##  $ flox services start             <- Starts all services
##  $ flox services status            <- Status of running services
##  $ flox activate --start-services  <- Activates & starts all
## ------------------------------------------------------------------
[services]
# myservice.command = "python3 -m http.server"


## Include ----------------------------------------------------------
## ... environments to create a composed environment
## ------------------------------------------------------------------
[include]
# environments = [
#     { dir = "../common" }
# ]


## Build and publish your own packages ------------------------------
##  $ flox build
##  $ flox publish
## ------------------------------------------------------------------
[build]

[build.tfaws-boid]
description = "Terraform+AWS boid — skill, canon, and scripts"
version = "0.3.0"
command = """
  # Skill (Claude Code auto-discovery)
  mkdir -p $out/share/claude/skills/tfaws-boid
  cp SKILL.md $out/share/claude/skills/tfaws-boid/SKILL.md

  # Canon data
  mkdir -p $out/share/boid/canon
  cp canon/*.json $out/share/boid/canon/

  # Runtime scripts
  mkdir -p $out/share/boid/scripts
  cp scripts/canon_lib.py scripts/canon_search.py \
     scripts/tf_plan_analyzer.py scripts/memory_lib.py \
     $out/share/boid/scripts/

  # Memory schema + migrations
  mkdir -p $out/share/boid/memory
  cp memory/schema.sql memory/migrate_v1_to_v2.sql $out/share/boid/memory/

  # Sandbox
  mkdir -p $out/share/boid/sandbox
  cp sandbox/validate.sh $out/share/boid/sandbox/

  # Claude Code settings (MCP servers + permissions)
  mkdir -p $out/share/claude
  cp .claude/settings.json $out/share/claude/settings.json
"""


## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
# systems = [
#   "aarch64-darwin",
#   "aarch64-linux",
#   "x86_64-darwin",
#   "x86_64-linux",
# ]
# Uncomment to disable CUDA detection.
# cuda-detection = false
